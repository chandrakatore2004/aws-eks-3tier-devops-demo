name: Terraform Security Scan (tfsec)

on:
  push:
    branches: [main, develop]
    paths:
      - 'terraform/**'
  workflow_dispatch:

jobs:
  tfsec-scan:
    name: Terraform Security Scan
    runs-on: [self-hosted, linux, qa]

    defaults:
      run:
        working-directory: terraform  # âœ… Set working directory for all run steps

    steps:
      - name: ğŸ›ï¸ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Run tfsec Scan
        run: |
          echo "Scanning Terraform code in branch: ${{ github.ref_name }}"
          tfsec . --tfvars-file=dev.tfvars > tfsec-report.txt || true
      - name: ğŸ§ª Convert Report to HTML
        run: |
          {
            echo "<!DOCTYPE html><html><head><meta charset='UTF-8'><title>tfsec Report</title>"
            echo "<style>body{font-family:sans-serif;}pre{white-space:pre-wrap;background:#f9f9f9;padding:1em;border:1px solid #ccc;}</style>"
            echo "</head><body><h1>tfsec Report - ${{ github.ref_name }}</h1><pre>"
            cat tfsec-report.txt
            echo "</pre></body></html>"
          } > tfsec-report.html
      - name: ğŸ—‚ï¸ Upload HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: tfsec-report-html-${{ github.ref_name }}
          path: terraform/tfsec-report.html