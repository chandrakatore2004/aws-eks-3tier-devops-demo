name: Terraform Security Scan (tfsec)

on:
  push:
    branches: [master, develop]
    paths:
      - 'terraform/**'
  workflow_dispatch:

jobs:
  tfsec:
    name: Run tfsec and export HTML report
    runs-on: [self-hosted, linux, qa]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq python3 python3-pip
          pip3 install jinja2

      - name: Run tfsec (JSON Output)
        run: |
          mkdir -p terraform/tfsec-report
          cd terraform
          tfsec --format json --out tfsec-report.json || true

      - name: Convert JSON to HTML (simple script)
        run: |
          cat > terraform/json_to_html.py <<EOF
          import json
          from jinja2 import Template

          with open("terraform/tfsec-report.json") as f:
              data = json.load(f)

          tmpl = Template(\"""
          <html><head><title>tfsec Report</title></head><body>
          <h1>tfsec Report - {{ results|length }} issues</h1>
          <ul>
          {% for item in results %}
            <li><strong>{{ item['rule_id'] }}</strong>: {{ item['description'] }}
              <br><code>{{ item['location']['filename'] }}:{{ item['location']['start_line'] }}</code>
            </li>
          {% endfor %}
          </ul></body></html>
          \""")

          with open("terraform/tfsec-report/index.html", "w") as f:
              f.write(tmpl.render(results=data["results"]))
          EOF

          python3 terraform/json_to_html.py

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: tfsec-html-report-${{ github.ref_name }}
          path: terraform/tfsec-report/index.html
