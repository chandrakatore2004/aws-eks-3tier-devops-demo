name: Terraform Security Scan (tfsec)

on:
  push:
    branches: [main, develop]
    paths:
      - 'terraform/**'
  workflow_dispatch:

jobs:
  tfsec-scan:
    name: Terraform Security Scan
    runs-on: [self-hosted, linux, qa]

    defaults:
      run:
        working-directory: terraform

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name:  Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name:  Run tfsec Scan (JSON Output)
        run: |
          echo "Running tfsec scan in branch: ${{ github.ref_name }}"
          tfsec . --tfvars-file=dev.tfvars --no-color --format json > tfsec-report.json || true

      - name: 📝 Write tfsec Summary to GitHub Actions UI
        run: |
          echo "## 🔐 Terraform Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Description | File | Line |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|------|------|" >> $GITHUB_STEP_SUMMARY

          jq -r '.results[] | 
            "| \(.severity) | \(.description | gsub("[\\n\\r]"; " ") | gsub("\\|"; "\\\\|")) | \(.location.filename | split("/") | last) | \(.location.start_line) |"' tfsec-report.json \
            >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Scan completed using [tfsec](https://github.com/aquasecurity/tfsec)_" >> $GITHUB_STEP_SUMMARY
